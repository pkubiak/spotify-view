<link href="https://fonts.googleapis.com/css2?family=Righteous&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=MuseoModerno:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Righteous', cursive;
    margin:0;
}

main {
    position: absolute;
    left: 0;top:0;width:100%;height:100%;;

    /* overflow: hidden; */
    flex-direction: column;
    /* max-height:100%; */
    background-size:cover;
    background-position: center;

    display: flex;
    opacity: 0;
    animation-name: appear;
    animation-delay: 1s;
    animation-iteration-count: 1;
    animation-duration: 1s;
    animation-fill-mode: forwards;
}

div.backdrop {
    overflow:hidden;
    backdrop-filter: blur(100px);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    padding:1cm;
    position: absolute;
    left: 0;top:0;width:100%;height:100%;;
    box-sizing: border-box;

}

img {
    max-width: 640px;
    max-height: 640px;
    box-shadow: 0 0 10px black;
    transform: perspective(1000px) rotateY(0deg);;
    /* backface-visibility: hidden; */
    transition: transform 1s;
}

img.x{
    transform: perspective(1000px)  rotateY(360deg);
}

h1 {
    font-size: 48px;
}
h2 {
    font-size: 32px;
    margin: 0
}
h1, h2, h3 {
    flex: 0;
    text-shadow: 0 0 10px #fffa;
    text-align: center;
}

@keyframes appear{
    from {opacity: 0;}
    to{opacity:1;}
}

a {
    width: 32px;
    height: 32px;
    background: url(https://developer.spotify.com/assets/branding-guidelines/icon4@2x.png);
    background-size:cover;
    position: absolute;
    right: 8px;
    top: 8px;
}

h2{font-weight:500}
</style>

<body onload="oninit()"><a></a></body>

<script>
const CLIENT_ID = '2788ef9b99b94f508d797cf63afdc445';
const REDIRECT_URL = window.location.href.indexOf('localhost') == -1 ? 'https:%2F%2Fpkubiak.github.io%2Fspotify%2Findex.html' : 'http:%2F%2Flocalhost%2Findex.html';
const POLL_INTERVAL = 5000;

var last= null, views=[];

function getToken() {
    let params = window.location.hash.substr(1).split('&');
    for(let param of params) {
        let [key, value] = param.split('=');
        if(key == 'access_token')
            return value;
    }
    return null;
}

function popView() {
    if(views.length > 1) {
        let view = views.shift();
        document.body.removeChild(view);
        console.log(views);
    }
}

function updateView(data) {
    if(last == data.item.uri)
        return;
    last = data.item.uri;

    let main = document.createElement('main');
    let backdrop = document.createElement('div');
    let img = document.createElement('img');
    let title = document.createElement('h1');
    let artist = document.createElement('h2');
    backdrop.classList.add('backdrop');
    let url = data.item.album.images[0].url;
    img.src = url;
    main.style.backgroundImage='url('+url+')';
    title.innerText = data.item.name;

    let artists = [];
    for(let artist of data.item.artists)
        artists.push(artist.name);
    artist.innerText = artists.join(', ');

    backdrop.appendChild(img);
    backdrop.appendChild(title);
    backdrop.appendChild(artist);
    main.appendChild(backdrop);
    document.body.appendChild(main);
    views.push(main);
    setTimeout(popView, 10000);
}

function readState(token) {
    fetch('https://api.spotify.com/v1/me/player/currently-playing', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            updateView(data)
        });
}

function oninit(){
    document.querySelector('a').href = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${REDIRECT_URL}&scope=user-read-currently-playing`;
    let token = getToken();
    console.log('token:', token);
    if(token) {
        readState(token);
        setInterval(function(){readState(token);}, POLL_INTERVAL);
    }
}
</script>